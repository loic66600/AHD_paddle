---
import '../styles/global.css';

import NavBar from '../components/navigation/NavBar.astro';
import Footer from '../components/Footer.astro';

import partials from '@porsche-design-system/components-js/partials/index.js';
import { withBase } from '../utils/url';

const { getFontLinks, getComponentChunkLinks, getLoaderScript } = partials;

const { title = 'AHD Paddle', showFooter = true } = Astro.props;
const favicon = withBase('/images/favicon.png');
const lightLogo = withBase('/images/logo.webp');
const darkLogo = withBase('/images/logo_blanc.png');
const apiKey = import.meta.env.PUBLIC_SNIPCART_API_KEY;
---
<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>{title}</title>
    <Fragment set:html={getFontLinks()} />
    <Fragment set:html={getComponentChunkLinks()} />
    <meta name="apple-mobile-web-app-title" content={title} />
    <meta name="theme-color" content="#010104" />
    <link rel="icon" type="image/png" href={favicon} />
    <link rel="apple-touch-icon" href={favicon} />
    
    <!-- Snipcart Initialization Script -->
    <script is:inline define:vars={{ apiKey }}>
      window.SnipcartSettings = {
        publicApiKey: apiKey,
        loadStrategy: 'on-user-interaction',
        addProductBehavior: 'none',
      };

      (()=>{var c,d;(d=(c=window.SnipcartSettings).version)!=null||(c.version="3.0");var s,S;(S=(s=window.SnipcartSettings).timeoutDuration)!=null||(s.timeoutDuration=2750);var l,p;(p=(l=window.SnipcartSettings).domain)!=null||(l.domain="cdn.snipcart.com");var w,u;(u=(w=window.SnipcartSettings).protocol)!=null||(w.protocol="https");var f=window.SnipcartSettings.version.includes("v3.0.0-ci")||window.SnipcartSettings.version!="3.0"&&window.SnipcartSettings.version.localeCompare("3.4.0",void 0,{numeric:!0,sensitivity:"base"})===-1,m=["focus","mouseover","touchmove","scroll","keydown"];window.LoadSnipcart=o;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",r):r();function r(){window.SnipcartSettings.loadStrategy?window.SnipcartSettings.loadStrategy==="on-user-interaction"&&(m.forEach(t=>document.addEventListener(t,o)),setTimeout(o,window.SnipcartSettings.timeoutDuration)):o()}var a=!1;function o(){if(a)return;a=!0;let t=document.getElementsByTagName("head")[0],e=document.querySelector("#snipcart"),i=document.querySelector(`src[src^="${window.SnipcartSettings.protocol}://${window.SnipcartSettings.domain}"][src$="snipcart.js"]`),n=document.querySelector(`link[href^="${window.SnipcartSettings.protocol}://${window.SnipcartSettings.domain}"][href$="snipcart.css"]`);e||(e=document.createElement("div"),e.id="snipcart",e.setAttribute("hidden","true"),document.body.appendChild(e)),v(e),i||(i=document.createElement("script"),i.src=`${window.SnipcartSettings.protocol}://${window.SnipcartSettings.domain}/themes/v${window.SnipcartSettings.version}/default/snipcart.js`,i.async=!0,t.appendChild(i)),n||(n=document.createElement("link"),n.rel="stylesheet",n.type="text/css",n.href=`${window.SnipcartSettings.protocol}://${window.SnipcartSettings.domain}/themes/v${window.SnipcartSettings.version}/default/snipcart.css`,t.prepend(n)),m.forEach(g=>document.removeEventListener(g,o))}function v(t){!f||(t.dataset.apiKey=window.SnipcartSettings.publicApiKey,window.SnipcartSettings.addProductBehavior&&(t.dataset.configAddProductBehavior=window.SnipcartSettings.addProductBehavior),window.SnipcartSettings.modalStyle&&(t.dataset.configModalStyle=window.SnipcartSettings.modalStyle),window.SnipcartSettings.currency&&(t.dataset.currency=window.SnipcartSettings.currency),window.SnipcartSettings.templatesUrl&&(t.dataset.templatesUrl=window.SnipcartSettings.templatesUrl))}})();
    </script>
  </head>
  <body>
    <!-- Barre de navigation globale utilisÃ©e sur toutes les pages -->
    <NavBar />

    <slot />

    <!-- Bas de page partagÃ© pour lâ€™ensemble du site -->
    {showFooter && <Footer />}

    <script type="module">
      const LOGO_LIGHT = ${JSON.stringify(lightLogo)};
      const LOGO_DARK = ${JSON.stringify(darkLogo)};

      const ready = (callback) => {
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
          requestAnimationFrame(callback);
        } else {
          document.addEventListener('DOMContentLoaded', () => requestAnimationFrame(callback), { once: true });
        }
      };

      const ensureVideoAutoplay = () => {
        const videos = document.querySelectorAll('video[data-auto-play]');
        videos.forEach((video) => {
          const startPlayback = () => {
            video.muted = true;
            video.setAttribute('muted', '');
            video.setAttribute('playsinline', '');
            const playPromise = video.play();
            if (playPromise && typeof playPromise.catch === 'function') {
              playPromise.catch(() => {
                const resume = () => {
                  video.play().catch(() => {});
                };
                window.addEventListener('pointerdown', resume, { once: true });
                window.addEventListener('touchstart', resume, { once: true });
              });
            }
          };

          if (video.readyState >= 2) {
            startPlayback();
          } else {
            video.addEventListener('canplaythrough', startPlayback, { once: true });
            video.load();
          }
        });
      };

      const initNavigation = () => {
        const drawer = document.getElementById('ahd-drawer');
        const toggleInput = document.getElementById('ahd-drawer-toggle');
        const toggleLabel = document.getElementById('ahd-menu-button');
        const nav = document.getElementById('ahd-global-nav');
        const navLogo = document.getElementById('ahd-nav-logo');
        const docEl = document.documentElement;

        if (drawer && toggleInput) {
          const setOpen = (open) => {
            toggleInput.checked = open;
            drawer.classList.toggle('is-open', open);
            toggleLabel?.setAttribute('aria-expanded', open ? 'true' : 'false');
            docEl.classList.toggle('drawer-open', open);
            if (open) {
              window.addEventListener('keydown', handleKeydown);
              window.addEventListener('click', handleOutsideClick, true);
            } else {
              window.removeEventListener('keydown', handleKeydown);
              window.removeEventListener('click', handleOutsideClick, true);
            }
          };

          const handleOutsideClick = (event) => {
            if (!drawer.contains(event.target) && !toggleLabel?.contains(event.target)) {
              setOpen(false);
            }
          };

          const handleKeydown = (event) => {
            if (event.key === 'Escape') {
              setOpen(false);
            }
          };

          toggleInput.addEventListener('change', () => setOpen(toggleInput.checked));

          // Ensure initial state sync in case of hydration timing
          requestAnimationFrame(() => setOpen(toggleInput.checked));
        }

        const sections = Array.from(document.querySelectorAll('[data-bg]'));
        let pageBgTimer = null;
        let navThemeTimer = null;

        const parseDelay = (value, fallback = 0) => {
          const parsed = Number.parseInt(value ?? '', 10);
          return Number.isFinite(parsed) && parsed >= 0 ? parsed : fallback;
        };

        const setBodyBackground = (color) => {
          if (color) {
            document.body?.style.setProperty('--page-bg', color);
          }
        };

        const setNavigationTheme = (theme) => {
          const isLight = theme === 'light';
          if (nav) {
            nav.classList.toggle('nav-light', isLight);
            nav.classList.toggle('nav-dark', !isLight);
          }
          if (navLogo) {
            navLogo.setAttribute('src', isLight ? LOGO_LIGHT : LOGO_DARK);
          }
        };

        const applyTheme = (section) => {
          if (!section) {
            return;
          }

          if (pageBgTimer) {
            window.clearTimeout(pageBgTimer);
            pageBgTimer = null;
          }
          if (navThemeTimer) {
            window.clearTimeout(navThemeTimer);
            navThemeTimer = null;
          }

          const targetColor = section.getAttribute('data-bg');
          const initialColor = section.getAttribute('data-bg-initial');
          const colorDelay = parseDelay(section.getAttribute('data-bg-delay'));

          const commitColor = () => {
            if (targetColor) {
              setBodyBackground(targetColor);
            }
          };

          if (colorDelay > 0) {
            if (initialColor) {
              setBodyBackground(initialColor);
            }
            pageBgTimer = window.setTimeout(() => {
              commitColor();
              pageBgTimer = null;
            }, colorDelay);
          } else {
            commitColor();
          }

          const targetNavTheme = section.getAttribute('data-nav') || 'dark';
          const initialNavTheme = section.getAttribute('data-nav-initial');
          const navDelay = parseDelay(section.getAttribute('data-nav-delay'), colorDelay);

          if (navDelay > 0) {
            if (initialNavTheme) {
              setNavigationTheme(initialNavTheme);
            }
            navThemeTimer = window.setTimeout(() => {
              setNavigationTheme(targetNavTheme);
              navThemeTimer = null;
            }, navDelay);
          } else {
            setNavigationTheme(targetNavTheme);
          }
        };

        if (sections.length) {
          let current = sections[0];
          applyTheme(current);

          const observer = new IntersectionObserver(
            (entries) => {
              entries.forEach((entry) => {
                if (entry.isIntersecting) {
                  current = entry.target;
                  applyTheme(current);
                }
              });
            },
            { threshold: 0.1, rootMargin: '-20% 0px -20% 0px' }
          );

          sections.forEach((section) => observer.observe(section));

          const updateOnScroll = () => {
            const viewportCenter = window.scrollY + window.innerHeight * 0.45;
            let candidate = current;
            for (const section of sections) {
              if (section.offsetTop <= viewportCenter) {
                candidate = section;
              }
            }
            if (candidate !== current) {
              current = candidate;
              applyTheme(current);
            }

          };

          window.addEventListener('scroll', updateOnScroll, { passive: true });
          window.addEventListener('resize', updateOnScroll, { passive: true });
          requestAnimationFrame(updateOnScroll);
        } else {
          applyTheme(document.body);
        }
      };

      ready(() => {
        initNavigation();
        ensureVideoAutoplay();
      });
    </script>

    <!-- Personnalisation du panier Snipcart -->
    <script type="module" is:inline>
      const customizeSnipcart = () => {
        if (!window.Snipcart) {
          setTimeout(customizeSnipcart, 200);
          return;
        }

        // Attendre que Snipcart soit prÃªt
        document.addEventListener('snipcart.ready', () => {
          console.log('ðŸ›’ Snipcart ready, customizing...');
          
          // (Lien panier gÃ©rÃ© plus bas via .snipcart-continue-shopping)
        });
      };

      // DÃ©marrer la personnalisation
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', customizeSnipcart);
      } else {
        customizeSnipcart();
      }

      // Force button color styling
      const forceButtonColors = () => {
        const paymentButton = document.querySelector('button.snipcart-button-primary, button[class*="snipcart-button-primary"]');
        if (paymentButton) {
          paymentButton.style.backgroundColor = '#2563eb';
          paymentButton.style.color = 'white';
          paymentButton.style.border = 'none';
          paymentButton.style.fontWeight = '600';
          console.log('âœ… Payment button colored');
        }
      };

      // Assombrir la nav quand le panier Snipcart est ouvert
      const setCartNavDark = (enabled) => {
        const nav = document.getElementById('ahd-global-nav');
        if (!nav) {
          return;
        }
        if (enabled) {
          nav.classList.add('nav-dark');
          nav.classList.remove('nav-light');
          nav.style.setProperty('--nav-bg', 'rgba(1, 1, 4, 0.65)');
          nav.style.setProperty('--nav-border', 'rgba(255, 255, 255, 0.15)');
          nav.style.setProperty('--nav-foreground', 'rgba(255, 255, 255, 0.92)');
          nav.style.setProperty('--nav-hover', '#ffffff');
        } else {
          nav.style.removeProperty('--nav-bg');
          nav.style.removeProperty('--nav-border');
          nav.style.removeProperty('--nav-foreground');
          nav.style.removeProperty('--nav-hover');
        }
      };

      // Rendre le lien "Continuer vos achats" fixe et toujours prÃ©sent
      const makeContinueShoppingClickable = () => {
        const existing = document.querySelector('.snipcart-continue-shopping');

        // Cibler en prioritÃ© le footer des actions (prÃ¨s du bouton paiement)
        const target = document.querySelector(
          '.snipcart-cart__footer-buttons, .snipcart-cart__footer, .snipcart-modal__footer, .snipcart__footer'
        );

        if (!target) {
          return;
        }

        let continueLink = existing;
        if (!continueLink) {
          continueLink = document.createElement('a');
          continueLink.className = 'snipcart-continue-shopping';
          continueLink.href = '#';
          continueLink.textContent = 'â† Continuer mes achats';

          continueLink.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (window.Snipcart && window.Snipcart.api && window.Snipcart.api.theme && window.Snipcart.api.theme.cart) {
              window.Snipcart.api.theme.cart.close();
            }
          });
        }

        // Forcer l'insertion en bas Ã  gauche du bloc d'actions
        if (continueLink.parentElement !== target) {
          target.insertBefore(continueLink, target.firstChild);
        }
      };

      // RÃ©injection permanente avec check plus frÃ©quent
      const ensureContinueShoppingVisible = () => {
        const isCartOpen = document.querySelector('.snipcart-modal-open, .snipcart-modal, .snipcart-cart');
        if (isCartOpen) {
          makeContinueShoppingClickable();
        }
      };

      // Ã‰couter l'ouverture du panier et rendre le bouton cliquable
      window.Snipcart?.events?.on('cart.opened', () => {
        console.log('ðŸ›’ Cart opened event fired');
        setTimeout(makeContinueShoppingClickable, 100);
        setTimeout(makeContinueShoppingClickable, 300);
        setTimeout(makeContinueShoppingClickable, 500);
        setTimeout(forceButtonColors, 100);
        setTimeout(forceButtonColors, 300);
        setTimeout(forceButtonColors, 500);
      });

      // Observer pour dÃ©tecter l'ouverture du panier et appliquer styles
      const setupCartObserver = () => {
        const observer = new MutationObserver(() => {
          const isCartOpen = document.querySelector('.snipcart-modal-open, .snipcart-modal, .snipcart-cart');
          if (isCartOpen && !document.querySelector('.snipcart-continue-shopping')) {
            ensureContinueShoppingVisible();
          }
        });
        observer.observe(document.body, { childList: true, subtree: true, attributes: true });
        console.log('âœ… Cart observer set up');
      };

      // Tenter l'injection dÃ¨s que Snipcart est prÃªt
      document.addEventListener('snipcart.ready', () => {
        setTimeout(makeContinueShoppingClickable, 200);
        setTimeout(setupCartObserver, 300);
        // VÃ©rifier moins souvent pour rÃ©duire les logs (toutes les 2 secondes)
        setInterval(ensureContinueShoppingVisible, 2000);

        // Assombrir la nav si le panier est dÃ©jÃ  ouvert
        if (document.documentElement.classList.contains('snipcart-modal-open')) {
          setCartNavDark(true);
        }
      });

      // Snipcart open/close events
      window.Snipcart?.events?.on('cart.opened', () => {
        setCartNavDark(true);
      });
      window.Snipcart?.events?.on('cart.closed', () => {
        // Laisser la page panier gÃ©rer le thÃ¨me si besoin
        setCartNavDark(false);
      });

      // Observer la classe sur html (fallback)
      const navStateObserver = new MutationObserver(() => {
        const isOpen = document.documentElement.classList.contains('snipcart-modal-open');
        if (isOpen) {
          setCartNavDark(true);
        }
      });
      navStateObserver.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });

      // DÃ©tection via hash (#/cart) si Snipcart n'applique pas de classe
      const checkCartHash = () => {
        const hash = window.location.hash || '';
        const isCartHash = hash.includes('/cart');
        const isAccountPage = window.location.pathname.includes('/compte');

        if (isCartHash) {
          setCartNavDark(true);
          return;
        }

        // Si on quitte le panier, revenir Ã  la nav normale (sauf page compte)
        if (!isAccountPage) {
          setCartNavDark(false);
        }
      };
      window.addEventListener('hashchange', checkCartHash);
      setTimeout(checkCartHash, 100);

      // VÃ©rifier aussi au chargement du document
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(setupCartObserver, 500);
        });
      } else {
        setTimeout(setupCartObserver, 500);
      }
    </script>

    <Fragment set:html={getLoaderScript()} />
  </body>
</html>
