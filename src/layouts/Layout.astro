---
import '../styles/global.css';

import NavBar from '../components/navigation/NavBar.astro';
import Footer from '../components/Footer.astro';

import partials from '@porsche-design-system/components-js/partials/index.js';
import { withBase } from '../utils/url';

const { getFontLinks, getComponentChunkLinks, getLoaderScript } = partials;

const { title = 'AHD Paddle' } = Astro.props;
const favicon = withBase('/images/favicon.png');
const lightLogo = withBase('/images/logo.webp');
const darkLogo = withBase('/images/logo_blanc.png');
---
<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>{title}</title>
    <Fragment set:html={getFontLinks()} />
    <Fragment set:html={getComponentChunkLinks()} />
    <meta name="apple-mobile-web-app-title" content={title} />
    <meta name="theme-color" content="#010104" />
    <link rel="icon" type="image/png" href={favicon} />
    <link rel="apple-touch-icon" href={favicon} />
  </head>
  <body>
    <!-- Barre de navigation globale utilisée sur toutes les pages -->
    <NavBar />

    <slot />

    <!-- Bas de page partagé pour l’ensemble du site -->
    <Footer />

    <script type="module">
      const LOGO_LIGHT = ${JSON.stringify(lightLogo)};
      const LOGO_DARK = ${JSON.stringify(darkLogo)};

      const ready = (callback) => {
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
          requestAnimationFrame(callback);
        } else {
          document.addEventListener('DOMContentLoaded', () => requestAnimationFrame(callback), { once: true });
        }
      };

      const ensureVideoAutoplay = () => {
        const videos = document.querySelectorAll('video[data-auto-play]');
        videos.forEach((video) => {
          const startPlayback = () => {
            video.muted = true;
            video.setAttribute('muted', '');
            video.setAttribute('playsinline', '');
            const playPromise = video.play();
            if (playPromise && typeof playPromise.catch === 'function') {
              playPromise.catch(() => {
                const resume = () => {
                  video.play().catch(() => {});
                };
                window.addEventListener('pointerdown', resume, { once: true });
                window.addEventListener('touchstart', resume, { once: true });
              });
            }
          };

          if (video.readyState >= 2) {
            startPlayback();
          } else {
            video.addEventListener('canplaythrough', startPlayback, { once: true });
            video.load();
          }
        });
      };

      const initNavigation = () => {
        const drawer = document.getElementById('ahd-drawer');
        const toggleInput = document.getElementById('ahd-drawer-toggle');
        const toggleLabel = document.getElementById('ahd-menu-button');
        const nav = document.getElementById('ahd-global-nav');
        const navLogo = document.getElementById('ahd-nav-logo');
        const docEl = document.documentElement;

        if (drawer && toggleInput) {
          const setOpen = (open) => {
            toggleInput.checked = open;
            drawer.classList.toggle('is-open', open);
            toggleLabel?.setAttribute('aria-expanded', open ? 'true' : 'false');
            docEl.classList.toggle('drawer-open', open);
            if (open) {
              window.addEventListener('keydown', handleKeydown);
              window.addEventListener('click', handleOutsideClick, true);
            } else {
              window.removeEventListener('keydown', handleKeydown);
              window.removeEventListener('click', handleOutsideClick, true);
            }
          };

          const handleOutsideClick = (event) => {
            if (!drawer.contains(event.target) && !toggleLabel?.contains(event.target)) {
              setOpen(false);
            }
          };

          const handleKeydown = (event) => {
            if (event.key === 'Escape') {
              setOpen(false);
            }
          };

          toggleInput.addEventListener('change', () => setOpen(toggleInput.checked));

          // Ensure initial state sync in case of hydration timing
          requestAnimationFrame(() => setOpen(toggleInput.checked));
        }

        const sections = Array.from(document.querySelectorAll('[data-bg]'));

        const applyTheme = (section) => {
          if (!section) {
            return;
          }
          const color = section.getAttribute('data-bg');
          if (color) {
            document.body?.style.setProperty('--page-bg', color);
          }

          const theme = section.getAttribute('data-nav') || 'dark';
          const isLight = theme === 'light';
          if (nav) {
            nav.classList.toggle('nav-light', isLight);
            nav.classList.toggle('nav-dark', !isLight);
          }
          if (navLogo) {
            navLogo.setAttribute('src', isLight ? LOGO_LIGHT : LOGO_DARK);
          }
        };

        if (sections.length) {
          let current = sections[0];
          applyTheme(current);

          const observer = new IntersectionObserver(
            (entries) => {
              entries.forEach((entry) => {
                if (entry.isIntersecting) {
                  current = entry.target;
                  applyTheme(current);
                }
              });
            },
            { threshold: 0.35 }
          );

          sections.forEach((section) => observer.observe(section));

          const updateOnScroll = () => {
            const viewportCenter = window.scrollY + window.innerHeight * 0.45;
            let candidate = current;
            for (const section of sections) {
              if (section.offsetTop <= viewportCenter) {
                candidate = section;
              }
            }
            if (candidate !== current) {
              current = candidate;
              applyTheme(current);
            }
          };

          window.addEventListener('scroll', updateOnScroll, { passive: true });
        } else {
          applyTheme(document.body);
        }
      };

      ready(() => {
        initNavigation();
        ensureVideoAutoplay();
      });
    </script>

    <Fragment set:html={getLoaderScript()} />
  </body>
</html>
