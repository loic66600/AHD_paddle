---
import '../styles/global.css';

import NavBar from '../components/navigation/NavBar.astro';
import Footer from '../components/Footer.astro';

import partials from '@porsche-design-system/components-js/partials/index.js';
import { withBase } from '../utils/url';

const { getFontLinks, getComponentChunkLinks, getLoaderScript } = partials;

const { title = 'AHD Paddle', showFooter = true } = Astro.props;
const favicon = withBase('/images/favicon.png');
const lightLogo = withBase('/images/logo.webp');
const darkLogo = withBase('/images/logo_blanc.png');
const apiKey = import.meta.env.PUBLIC_SNIPCART_API_KEY;
---
<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>{title}</title>
    <Fragment set:html={getFontLinks()} />
    <Fragment set:html={getComponentChunkLinks()} />
    <meta name="apple-mobile-web-app-title" content={title} />
    <meta name="theme-color" content="#010104" />
    <link rel="icon" type="image/png" href={favicon} />
    <link rel="apple-touch-icon" href={favicon} />
    
    <!-- Snipcart Initialization Script -->
    <script is:inline define:vars={{ apiKey }}>
      window.SnipcartSettings = {
        publicApiKey: apiKey,
        loadStrategy: 'on-user-interaction',
        addProductBehavior: 'none',
      };

      (()=>{var c,d;(d=(c=window.SnipcartSettings).version)!=null||(c.version="3.0");var s,S;(S=(s=window.SnipcartSettings).timeoutDuration)!=null||(s.timeoutDuration=2750);var l,p;(p=(l=window.SnipcartSettings).domain)!=null||(l.domain="cdn.snipcart.com");var w,u;(u=(w=window.SnipcartSettings).protocol)!=null||(w.protocol="https");var f=window.SnipcartSettings.version.includes("v3.0.0-ci")||window.SnipcartSettings.version!="3.0"&&window.SnipcartSettings.version.localeCompare("3.4.0",void 0,{numeric:!0,sensitivity:"base"})===-1,m=["focus","mouseover","touchmove","scroll","keydown"];window.LoadSnipcart=o;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",r):r();function r(){window.SnipcartSettings.loadStrategy?window.SnipcartSettings.loadStrategy==="on-user-interaction"&&(m.forEach(t=>document.addEventListener(t,o)),setTimeout(o,window.SnipcartSettings.timeoutDuration)):o()}var a=!1;function o(){if(a)return;a=!0;let t=document.getElementsByTagName("head")[0],e=document.querySelector("#snipcart"),i=document.querySelector(`src[src^="${window.SnipcartSettings.protocol}://${window.SnipcartSettings.domain}"][src$="snipcart.js"]`),n=document.querySelector(`link[href^="${window.SnipcartSettings.protocol}://${window.SnipcartSettings.domain}"][href$="snipcart.css"]`);e||(e=document.createElement("div"),e.id="snipcart",e.setAttribute("hidden","true"),document.body.appendChild(e)),v(e),i||(i=document.createElement("script"),i.src=`${window.SnipcartSettings.protocol}://${window.SnipcartSettings.domain}/themes/v${window.SnipcartSettings.version}/default/snipcart.js`,i.async=!0,t.appendChild(i)),n||(n=document.createElement("link"),n.rel="stylesheet",n.type="text/css",n.href=`${window.SnipcartSettings.protocol}://${window.SnipcartSettings.domain}/themes/v${window.SnipcartSettings.version}/default/snipcart.css`,t.prepend(n)),m.forEach(g=>document.removeEventListener(g,o))}function v(t){!f||(t.dataset.apiKey=window.SnipcartSettings.publicApiKey,window.SnipcartSettings.addProductBehavior&&(t.dataset.configAddProductBehavior=window.SnipcartSettings.addProductBehavior),window.SnipcartSettings.modalStyle&&(t.dataset.configModalStyle=window.SnipcartSettings.modalStyle),window.SnipcartSettings.currency&&(t.dataset.currency=window.SnipcartSettings.currency),window.SnipcartSettings.templatesUrl&&(t.dataset.templatesUrl=window.SnipcartSettings.templatesUrl))}})();
    </script>
  </head>
  <body>
    <!-- Barre de navigation globale utilisÃ©e sur toutes les pages -->
    <NavBar />

    <slot />

    <!-- Bas de page partagÃ© pour lâ€™ensemble du site -->
    {showFooter && <Footer />}

    <script type="module">
      const LOGO_LIGHT = ${JSON.stringify(lightLogo)};
      const LOGO_DARK = ${JSON.stringify(darkLogo)};

      const ready = (callback) => {
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
          requestAnimationFrame(callback);
        } else {
          document.addEventListener('DOMContentLoaded', () => requestAnimationFrame(callback), { once: true });
        }
      };

      const ensureVideoAutoplay = () => {
        const videos = document.querySelectorAll('video[data-auto-play]');
        videos.forEach((video) => {
          const startPlayback = () => {
            video.muted = true;
            video.setAttribute('muted', '');
            video.setAttribute('playsinline', '');
            const playPromise = video.play();
            if (playPromise && typeof playPromise.catch === 'function') {
              playPromise.catch(() => {
                const resume = () => {
                  video.play().catch(() => {});
                };
                window.addEventListener('pointerdown', resume, { once: true });
                window.addEventListener('touchstart', resume, { once: true });
              });
            }
          };

          if (video.readyState >= 2) {
            startPlayback();
          } else {
            video.addEventListener('canplaythrough', startPlayback, { once: true });
            video.load();
          }
        });
      };

      const initNavigation = () => {
        const drawer = document.getElementById('ahd-drawer');
        const toggleInput = document.getElementById('ahd-drawer-toggle');
        const toggleLabel = document.getElementById('ahd-menu-button');
        const nav = document.getElementById('ahd-global-nav');
        const navLogo = document.getElementById('ahd-nav-logo');
        const docEl = document.documentElement;

        if (drawer && toggleInput) {
          const setOpen = (open) => {
            toggleInput.checked = open;
            drawer.classList.toggle('is-open', open);
            toggleLabel?.setAttribute('aria-expanded', open ? 'true' : 'false');
            docEl.classList.toggle('drawer-open', open);
            if (open) {
              window.addEventListener('keydown', handleKeydown);
              window.addEventListener('click', handleOutsideClick, true);
            } else {
              window.removeEventListener('keydown', handleKeydown);
              window.removeEventListener('click', handleOutsideClick, true);
            }
          };

          const handleOutsideClick = (event) => {
            if (!drawer.contains(event.target) && !toggleLabel?.contains(event.target)) {
              setOpen(false);
            }
          };

          const handleKeydown = (event) => {
            if (event.key === 'Escape') {
              setOpen(false);
            }
          };

          toggleInput.addEventListener('change', () => setOpen(toggleInput.checked));

          // Ensure initial state sync in case of hydration timing
          requestAnimationFrame(() => setOpen(toggleInput.checked));
        }

        const sections = Array.from(document.querySelectorAll('[data-bg]'));
        let pageBgTimer = null;
        let navThemeTimer = null;

        const parseDelay = (value, fallback = 0) => {
          const parsed = Number.parseInt(value ?? '', 10);
          return Number.isFinite(parsed) && parsed >= 0 ? parsed : fallback;
        };

        const setBodyBackground = (color) => {
          if (color) {
            document.body?.style.setProperty('--page-bg', color);
          }
        };

        const setNavigationTheme = (theme) => {
          const isLight = theme === 'light';
          if (nav) {
            nav.classList.toggle('nav-light', isLight);
            nav.classList.toggle('nav-dark', !isLight);
          }
          if (navLogo) {
            navLogo.setAttribute('src', isLight ? LOGO_LIGHT : LOGO_DARK);
          }
        };

        const applyTheme = (section) => {
          if (!section) {
            return;
          }

          if (pageBgTimer) {
            window.clearTimeout(pageBgTimer);
            pageBgTimer = null;
          }
          if (navThemeTimer) {
            window.clearTimeout(navThemeTimer);
            navThemeTimer = null;
          }

          const targetColor = section.getAttribute('data-bg');
          const initialColor = section.getAttribute('data-bg-initial');
          const colorDelay = parseDelay(section.getAttribute('data-bg-delay'));

          const commitColor = () => {
            if (targetColor) {
              setBodyBackground(targetColor);
            }
          };

          if (colorDelay > 0) {
            if (initialColor) {
              setBodyBackground(initialColor);
            }
            pageBgTimer = window.setTimeout(() => {
              commitColor();
              pageBgTimer = null;
            }, colorDelay);
          } else {
            commitColor();
          }

          const targetNavTheme = section.getAttribute('data-nav') || 'dark';
          const initialNavTheme = section.getAttribute('data-nav-initial');
          const navDelay = parseDelay(section.getAttribute('data-nav-delay'), colorDelay);

          if (navDelay > 0) {
            if (initialNavTheme) {
              setNavigationTheme(initialNavTheme);
            }
            navThemeTimer = window.setTimeout(() => {
              setNavigationTheme(targetNavTheme);
              navThemeTimer = null;
            }, navDelay);
          } else {
            setNavigationTheme(targetNavTheme);
          }
        };

        if (sections.length) {
          let current = sections[0];
          applyTheme(current);

          const observer = new IntersectionObserver(
            (entries) => {
              entries.forEach((entry) => {
                if (entry.isIntersecting) {
                  current = entry.target;
                  applyTheme(current);
                }
              });
            },
            { threshold: 0.1, rootMargin: '-20% 0px -20% 0px' }
          );

          sections.forEach((section) => observer.observe(section));

          const updateOnScroll = () => {
            const viewportCenter = window.scrollY + window.innerHeight * 0.45;
            let candidate = current;
            for (const section of sections) {
              if (section.offsetTop <= viewportCenter) {
                candidate = section;
              }
            }
            if (candidate !== current) {
              current = candidate;
              applyTheme(current);
            }

          };

          window.addEventListener('scroll', updateOnScroll, { passive: true });
          window.addEventListener('resize', updateOnScroll, { passive: true });
          requestAnimationFrame(updateOnScroll);
        } else {
          applyTheme(document.body);
        }
      };

      ready(() => {
        initNavigation();
        ensureVideoAutoplay();
      });
    </script>

    <!-- Personnalisation du panier Snipcart -->
    <script type="module" is:inline>
      const customizeSnipcart = () => {
        if (!window.Snipcart) {
          setTimeout(customizeSnipcart, 200);
          return;
        }

        // Attendre que Snipcart soit prÃªt
        document.addEventListener('snipcart.ready', () => {
          console.log('ðŸ›’ Snipcart ready, customizing...');
          
          // Ajouter le lien "Continuer mes achats" dans le panier
          const addContinueShoppingLink = () => {
            // Supprimer l'ancien lien s'il existe
            const oldLink = document.getElementById('custom-continue-shopping');
            if (oldLink) oldLink.remove();

            // Chercher plusieurs emplacements possibles dans le panier
            const cartSummary = document.querySelector('.snipcart-cart-summary');
            const cartFooter = document.querySelector('.snipcart-cart-summary__footer');
            const cartContent = document.querySelector('.snipcart__box--badge-highlight');
            const checkoutBtn = document.querySelector('.snipcart-checkout');
            
            const targetElement = cartFooter || cartSummary || cartContent || checkoutBtn?.parentElement;
            
            if (targetElement) {
              const continueLink = document.createElement('a');
              continueLink.id = 'custom-continue-shopping';
              continueLink.href = '#';
              continueLink.textContent = 'â† Continuer mes achats';
              continueLink.style.cssText = `
                display: block;
                text-align: center;
                margin: 1rem auto 0.5rem;
                padding: 0.875rem 1.5rem;
                color: #1a1a1a;
                text-decoration: none;
                font-size: 0.9rem;
                font-weight: 600;
                border: 2px solid #e5e7eb;
                border-radius: 0.75rem;
                transition: all 0.2s;
                background: white;
                max-width: 300px;
              `;
              continueLink.addEventListener('mouseenter', () => {
                continueLink.style.borderColor = '#1a1a1a';
                continueLink.style.backgroundColor = '#f9fafb';
              });
              continueLink.addEventListener('mouseleave', () => {
                continueLink.style.borderColor = '#e5e7eb';
                continueLink.style.backgroundColor = 'white';
              });
              continueLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (window.Snipcart && window.Snipcart.api && window.Snipcart.api.theme && window.Snipcart.api.theme.cart) {
                  window.Snipcart.api.theme.cart.close();
                }
                console.log('âœ… Cart closed');
              });
              
              targetElement.appendChild(continueLink);
              console.log('âœ… Continue shopping link added to:', targetElement.className);
            } else {
              console.log('âš ï¸ Could not find suitable target element for continue shopping link');
            }
          };

          // Observer pour dÃ©tecter l'ouverture du panier
          window.Snipcart.events.on('cart.opened', () => {
            console.log('ðŸ›’ Cart opened, adding link...');
            // Essayer plusieurs fois car le DOM du panier met du temps Ã  se construire
            setTimeout(addContinueShoppingLink, 100);
            setTimeout(addContinueShoppingLink, 500);
            setTimeout(addContinueShoppingLink, 1000);
          });

          // Observer les changements DOM dans le panier
          const observeCart = () => {
            const cartContainer = document.querySelector('#snipcart');
            if (cartContainer) {
              const observer = new MutationObserver((mutations) => {
                const cartVisible = document.querySelector('.snipcart-modal--opened, .snipcart-cart');
                if (cartVisible && !document.getElementById('custom-continue-shopping')) {
                  setTimeout(addContinueShoppingLink, 300);
                }
              });
              observer.observe(cartContainer, { childList: true, subtree: true });
              console.log('âœ… Cart observer set up');
            }
          };

          setTimeout(observeCart, 1000);
        });
      };

      // DÃ©marrer la personnalisation
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', customizeSnipcart);
      } else {
        customizeSnipcart();
      }
    </script>

    <Fragment set:html={getLoaderScript()} />
  </body>
</html>
