---
import '../styles/global.css';

import NavBar from '../components/navigation/NavBar.astro';
import Footer from '../components/Footer.astro';

import partials from '@porsche-design-system/components-js/partials/index.js';
import { withBase } from '../utils/url';

const {
  getMetaTagsAndIconLinks,
  getFontLinks,
  getComponentChunkLinks,
  getLoaderScript
} = partials;

const { title = 'AHD Paddle' } = Astro.props;
const favicon = withBase('/images/favicon.png');
const lightLogo = withBase('/images/logo.webp');
const darkLogo = withBase('/images/logo_blanc.png');
---
<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>{title}</title>
    <Fragment set:html={getMetaTagsAndIconLinks({ appTitle: title, appLogo: favicon })} />
    <Fragment set:html={getFontLinks()} />
    <Fragment set:html={getComponentChunkLinks()} />
    <link rel="icon" type="image/png" href={favicon} />
  </head>
  <body>
    <!-- Barre de navigation globale utilisée sur toutes les pages -->
    <NavBar />

    <slot />

    <!-- Bas de page partagé pour l’ensemble du site -->
    <Footer />

    <script type="module">
      // Orchestration du tiroir de navigation et du changement de thème selon les sections
      const drawer = document.getElementById('ahd-drawer');
      const toggle = document.getElementById('ahd-menu-button');
      const nav = document.getElementById('ahd-global-nav');
      const navLogo = document.getElementById('ahd-nav-logo');
      const LOGO_LIGHT = ${JSON.stringify(lightLogo)};
      const LOGO_DARK = ${JSON.stringify(darkLogo)};

      if (drawer && toggle) {
        const closeDrawer = (event) => {
          if (!drawer.classList.contains('translate-x-0')) {
            return;
          }
          if (event.type === 'keydown' && event.key !== 'Escape') {
            return;
          }
          drawer.classList.remove('translate-x-0');
          drawer.classList.add('-translate-x-full');
          toggle.setAttribute('aria-expanded', 'false');
          window.removeEventListener('keydown', closeDrawer);
          window.removeEventListener('click', handleOutsideClick, true);
        };

        const handleOutsideClick = (event) => {
          if (!drawer.contains(event.target) && event.target !== toggle) {
            closeDrawer(event);
          }
        };

        toggle.addEventListener('click', () => {
          const isOpen = drawer.classList.toggle('translate-x-0');
          drawer.classList.toggle('-translate-x-full', !isOpen);
          toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
          if (isOpen) {
            window.addEventListener('keydown', closeDrawer);
            window.addEventListener('click', handleOutsideClick, true);
          } else {
            window.removeEventListener('keydown', closeDrawer);
            window.removeEventListener('click', handleOutsideClick, true);
          }
        });
      }

      const applyNavTheme = (section) => {
        if (!nav || !section) {
          return;
        }
        const theme = section.getAttribute('data-nav') || 'dark';
        const isLight = theme === 'light';
        nav.classList.toggle('nav-light', isLight);
        nav.classList.toggle('nav-dark', !isLight);
        if (navLogo) {
          navLogo.setAttribute('src', isLight ? LOGO_LIGHT : LOGO_DARK);
        }
      };

      const themedSections = document.querySelectorAll('[data-bg]');
      if (themedSections.length) {
        const setBackground = (section) => {
          const color = section.getAttribute('data-bg');
          if (color) {
            document.body.style.setProperty('--page-bg', color);
          }
          applyNavTheme(section);
        };

        setBackground(themedSections[0]);

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                setBackground(entry.target);
              }
            });
          },
          { threshold: 0.5 }
        );

        themedSections.forEach((section) => observer.observe(section));
      } else {
        applyNavTheme(document.body);
      }
    </script>

    <Fragment set:html={getLoaderScript()} />
  </body>
</html>
