---
import Layout from '../../layouts/Layout.astro';
import { withBase } from '../../utils/url';
import { getProductBySlug, getRelatedProducts, products } from '../../data/products';

export function getStaticPaths() {
  return products.map(product => ({
    params: { slug: product.slug }
  }));
}

interface Props {
  slug: string;
}

const { slug } = Astro.params;
const product = getProductBySlug(slug!);

if (!product) {
  return Astro.redirect(withBase('/'));
}

const relatedProducts = getRelatedProducts(product);
const descriptionImages = product.descriptionImages ?? [];
const descriptionProgramme = product.programme ?? 'Programme en cours de mise à jour.';
const descriptionPresentation = product.presentation ?? product.shortDescription;
const hasDescription = Boolean(descriptionProgramme || descriptionPresentation || descriptionImages.length);
const performanceMetrics = product.performance ?? [];
const hasPerformance = performanceMetrics.length > 0;
const technologyLinesRaw = product.technology ? product.technology.split('\n') : ['Informations techniques en cours de mise à jour.'];
const technologyLines = technologyLinesRaw.length > 1
  ? technologyLinesRaw
  : technologyLinesRaw[0]
      .split('. ')
      .map((line) => line.trim())
      .filter(Boolean)
      .map((line) => (line.endsWith('.') ? line : `${line}.`));
const shapeItems = [
  {
    key: 'outline',
    title: 'Outline',
    description: product.shapeDescriptions?.outline,
    image: product.shapeImages?.outline
  },
  {
    key: 'carene-rails',
    title: 'Carène & rails',
    description: product.shapeDescriptions?.careneRails,
    image: product.shapeImages?.careneRails
  },
  {
    key: 'tail',
    title: 'Tail',
    description: product.shapeDescriptions?.tail,
    image: product.shapeImages?.tail
  },
  {
    key: 'nose',
    title: 'Nose',
    description: product.shapeDescriptions?.nose,
    image: product.shapeImages?.nose
  }
]
  .filter((item) => item.description)
  .map((item) => ({
    ...item,
    image: item.image ?? product.images[0]?.main
  }));
const shapeFallback = [
  {
    key: 'outline',
    title: 'Outline',
    description: 'Détails du shape disponibles prochainement.',
    image: product.images[0]?.main
  },
  {
    key: 'carene-rails',
    title: 'Carène & rails',
    description: 'Détails du shape disponibles prochainement.',
    image: product.images[0]?.main
  },
  {
    key: 'tail',
    title: 'Tail',
    description: 'Détails du shape disponibles prochainement.',
    image: product.images[0]?.main
  },
  {
    key: 'nose',
    title: 'Nose',
    description: 'Détails du shape disponibles prochainement.',
    image: product.images[0]?.main
  }
];
const finalShapeItems = shapeItems.length ? shapeItems : shapeFallback;
---

<Layout title={`AHD Paddle | ${product.name}`}>
  <main class="bg-white pb-24" data-bg="#ffffff" data-nav="light">
    <!-- Breadcrumb -->
    <section class="container pt-28 md:pt-32 text-midnight">
      <nav class="flex items-center gap-2 text-sm text-midnight/60 mb-12">
        <a href={withBase('/')} class="font-medium text-midnight/70 hover:text-midnight">Accueil</a>
        <span class="text-midnight/30">/</span>
        <a href={withBase(`/${product.category}`)} class="font-medium text-midnight/70 hover:text-midnight capitalize">
          {product.category === 'wingfoil' ? 'Wingfoil' : product.category === 'windsurf' ? 'Windsurf' : 'Accessoires'}
        </a>
        <span class="text-midnight/30">/</span>
        <span class="text-midnight font-semibold">{product.name}</span>
      </nav>

      <!-- Produit principal -->
      <div class="grid gap-12 md:grid-cols-2 mb-16">
        <!-- Galerie d'images -->
        <div class="space-y-4">
          <div class="relative w-full aspect-[3/4] overflow-hidden rounded-[2.5rem] bg-gradient-to-b from-midnight/10 via-midnight/5 to-white">
            <img 
              id="mainImage"
              src={product.images[0].main} 
              alt={product.name}
              class="h-full w-full object-contain"
            />
          </div>
          {product.images.length > 1 && (
            <div class="flex gap-3 overflow-x-auto pb-2">
              {product.images.map((img, idx) => (
                <button
                  class="flex-shrink-0 w-16 h-20 rounded-lg border-2 border-midnight/10 overflow-hidden cursor-pointer transition hover:border-midnight thumbnail-btn"
                  data-src={img.main}
                  aria-label={`Image ${idx + 1}`}
                >
                  <img src={img.thumb} alt="" class="w-full h-full object-contain" />
                </button>
              ))}
            </div>
          )}
        </div>

        <!-- Infos produit -->
        <div class="space-y-6">
          <div>
            <h1 class="text-3xl md:text-4xl font-semibold mb-2">{product.name}</h1>
            <p class="text-midnight/70">{product.shortDescription}</p>
          </div>

          <!-- Taille -->
          {product.sizes && product.sizes.length > 0 && (
            <div class="space-y-3">
              <label class="text-sm font-semibold text-midnight/70">Taille</label>
              <select class="w-full md:w-32 rounded-xl border border-midnight/15 bg-white px-4 py-3 text-sm text-midnight focus:border-midnight focus:outline-none">
                <option>Sélectionner</option>
                {product.sizes.map(size => (
                  <option>{size}</option>
                ))}
              </select>
            </div>
          )}

          <!-- Couleur -->
          {product.variants && product.variants.length > 0 && (
            <div class="space-y-3">
              <label class="text-sm font-semibold text-midnight/70">Couleur</label>
              <div class="flex gap-3">
                {product.variants.map(variant => (
                  <button
                    class="w-8 h-8 rounded-lg border-2 border-midnight/20 transition hover:border-midnight cursor-pointer"
                    style={`background-color: ${variant.colorHex}`}
                    title={variant.color}
                    aria-label={`Couleur: ${variant.color}`}
                  />
                ))}
              </div>
            </div>
          )}

          <!-- Prix -->
          <div class="border-t border-b border-midnight/10 py-6">
            <p class="text-3xl font-semibold">{product.price}€</p>
            <p class="text-xs text-midnight/60 mt-1">Taxes incluses</p>
          </div>

          <!-- Actions -->
          <div class="flex gap-3">
            <div class="flex items-center bg-midnight rounded-xl overflow-hidden">
              <button id="qty-minus" class="px-3 py-2 text-sm text-white hover:bg-midnight/80 transition font-semibold">−</button>
              <input id="qty-input" type="text" value="1" class="w-12 text-center bg-white text-midnight border-none focus:outline-none font-semibold" />
              <button id="qty-plus" class="px-3 py-2 text-sm text-white hover:bg-midnight/80 transition font-semibold">+</button>
            </div>
            <button 
              id="snipcart-button"
              class="snipcart-add-item flex-1 rounded-xl bg-midnight px-6 py-3 text-sm font-semibold uppercase tracking-[0.25em] text-white hover:bg-midnight/80 transition"
              data-item-id={product.slug}
              data-item-name={product.name}
              data-item-price={product.price}
              data-item-url={Astro.url.origin + withBase(`/produit/${product.slug}`)}
              data-item-description={product.shortDescription}
              data-item-image={Astro.url.origin + product.images[0]?.main}
              data-item-stackable="never"
              data-item-custom1-name={product.variants && product.variants.length > 0 ? 'Couleur' : undefined}
              data-item-custom1-options={product.variants && product.variants.length > 0 ? product.variants.map((v) => v.color).join('|') : undefined}
              data-item-custom1-value={product.variants && product.variants.length > 0 ? product.variants[0]?.color : undefined}
              data-item-custom2-name={product.sizes && product.sizes.length > 0 ? 'Taille' : undefined}
              data-item-custom2-options={product.sizes && product.sizes.length > 0 ? product.sizes.join('|') : undefined}
              data-item-custom2-value={product.sizes && product.sizes.length > 0 ? product.sizes[0] : undefined}
            >
              Ajouter au panier
            </button>
            <button class="px-4 py-3 rounded-xl border border-midnight/15 hover:border-midnight transition">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
              </svg>
            </button>
          </div>

     
        </div>
      </div>

      <!-- Notification d'ajout au panier -->
      <div id="cart-notification" class="fixed top-24 right-6 z-50 bg-green-600 text-white px-6 py-4 rounded-xl shadow-lg opacity-0 transition-opacity duration-500 pointer-events-none">
        <div class="font-semibold">✓ Produit ajouté au panier !</div>
        <div id="notification-details" class="text-sm mt-1 opacity-90"></div>
      </div>

      <!-- Description -->
      {hasDescription && (
        <div class="mb-16 space-y-6">
          <h2 class="text-2xl font-semibold">Description</h2>
          <div class="space-y-2">
            <h3 class="font-semibold">Programme</h3>
            <p class="text-midnight/70 leading-tight">{descriptionProgramme}</p>
          </div>
          <div class="space-y-2">
            <h3 class="font-semibold">Présentation</h3>
            <div class="space-y-4">
              {descriptionPresentation.split('\n').filter(Boolean).map((paragraph, idx) => (
                <p key={idx} class="text-midnight/70 leading-normal">{paragraph}</p>
              ))}
            </div>
          </div>
          {descriptionImages.length > 0 && (
            <div class="grid gap-6 md:grid-cols-2">
              {descriptionImages.map((image, idx) => (
                <div key={idx} class="overflow-hidden rounded-[2rem] shadow-[0_20px_40px_rgba(15,23,42,0.12)]">
                  <img src={image} alt={`${product.name} ambiance ${idx + 1}`} class="h-full w-full object-cover" loading="lazy" />
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      <!-- Shape -->
      {finalShapeItems.length > 0 && (
        <div class="mb-16 space-y-6">
          <h2 class="text-2xl font-semibold">Shape</h2>
          <div class="space-y-4">
            {finalShapeItems.map((item, idx) => (
              <details
                key={item.key}
                class="rounded-[2rem] border border-midnight/10 bg-slate-50 p-6 transition-colors hover:bg-slate-100"
                style="transition: background-color 300ms cubic-bezier(0.4, 0, 0.2, 1), border-color 300ms cubic-bezier(0.4, 0, 0.2, 1);"
                open={idx === 0}
              >
                <summary class="cursor-pointer list-none text-sm font-semibold uppercase tracking-[0.3em] text-midnight/70">
                  {item.title}
                </summary>
                <div class="mt-4 space-y-4">
                  <p class="text-midnight/70 leading-normal whitespace-pre-wrap">{item.description}</p>
                  {item.image && (
                    <div class="flex items-center justify-center rounded-[1.5rem] bg-slate-50 p-4">
                      <img src={item.image} alt={`${product.name} ${item.title}`} class="max-h-64 w-full object-contain" loading="lazy" />
                    </div>
                  )}
                </div>
              </details>
            ))}
          </div>
        </div>
      )}

      <!-- Performance -->
      <div class="mb-16 space-y-6">
        <h2 class="text-2xl font-semibold">Performance</h2>
        <div class="grid gap-8 lg:grid-cols-[1.1fr_0.9fr] lg:items-center">
          <div class="flex items-center justify-center rounded-[2.5rem] bg-slate-50 p-6">
            <img src={product.images[0].main} alt={`${product.name} performance`} class="max-h-96 w-full object-contain" loading="lazy" />
          </div>
          <div class="space-y-4">
            {hasPerformance ? (
              performanceMetrics.map(metric => (
                <div class="space-y-2">
                  <div class="flex justify-between text-sm">
                    <span class="font-semibold">{metric.label}</span>
                    <span class="text-midnight/60">{metric.level}%</span>
                  </div>
                  <div class="w-full h-2 bg-midnight/10 rounded-full overflow-hidden">
                    <div class="h-full bg-midnight rounded-full" style={`width: ${metric.level}%`}></div>
                  </div>
                </div>
              ))
            ) : (
              <p class="text-midnight/70 leading-normal">
                Courbes de performance en cours de mise à jour.
              </p>
            )}
          </div>
        </div>
      </div>

      <!-- Technologie -->
      <div class="mb-16 space-y-6">
        <h2 class="text-2xl md:text-3xl font-semibold">Technologie EPS PRO</h2>
        <div class="grid gap-10 lg:grid-cols-[1.2fr_0.8fr] lg:items-center">
          <ul class="list-disc pl-5 space-y-3 text-midnight/80 leading-normal text-sm md:text-base">
            {technologyLines.map((line, idx) => (
              <li key={idx}>{line.trim()}</li>
            ))}
          </ul>
          {product.technologyImage && (
            <div class="flex items-center justify-center">
              <img src={product.technologyImage} alt="Technologie EPS PRO" class="max-h-96 w-full object-contain" loading="lazy" />
            </div>
          )}
        </div>
      </div>

      <!-- Fiche technique -->
      <div class="mb-16 space-y-6">
        <h2 class="text-2xl font-semibold">Fiche technique</h2>
        {product.specs && product.specs.length > 0 ? (
          product.specs.map((spec, idx) => (
            <div key={idx} class="rounded-[2.5rem] border border-midnight/10 bg-white/70 p-8 overflow-x-auto">
              <h3 class="font-semibold mb-4">{spec.name}</h3>
              <table class="w-full text-sm">
                <tbody>
                  {Object.entries(spec.specs).map(([key, value]) => (
                    <tr key={key} class="border-b border-midnight/10">
                      <td class="py-3 pr-4 font-semibold text-midnight/70">{key}</td>
                      <td class="py-3 text-midnight font-semibold">{value}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          ))
        ) : (
          <div class="rounded-[2.5rem] border border-midnight/10 bg-white/70 p-8 text-midnight/70">
            Fiche technique en cours de mise à jour.
          </div>
        )}
      </div>

      <!-- Produits connexes -->
      {relatedProducts.length > 0 && (
        <div class="space-y-6">
          <h2 class="text-2xl font-semibold">Autres articles de la même catégorie</h2>
          <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-4">
            {relatedProducts.map(relatedProduct => (
              <a
                href={withBase(`/produit/${relatedProduct.slug}`)}
                class="group relative overflow-hidden rounded-[2.5rem] bg-white shadow-[0_24px_60px_rgba(15,23,42,0.08)] transition hover:shadow-[0_24px_60px_rgba(15,23,42,0.15)] hover:-translate-y-1"
              >
                <div class="relative w-full aspect-[3/4] overflow-hidden bg-gradient-to-b from-midnight/10 via-midnight/5 to-white">
                  <img
                    src={relatedProduct.images[0].main}
                    alt={relatedProduct.name}
                    class="h-full w-full object-contain transition-transform group-hover:scale-105"
                  />
                </div>
                <div class="p-4 text-midnight">
                  <h3 class="font-semibold text-sm mb-1">{relatedProduct.name}</h3>
                  <p class="text-xs text-midnight/60 mb-2">{relatedProduct.shortDescription}</p>
                  <p class="font-semibold">{relatedProduct.price}€</p>
                </div>
              </a>
            ))}
          </div>
        </div>
      )}
    </section>
  </main>

  <script type="module" is:inline>
    const mainImage = document.getElementById('mainImage');
    const thumbnailBtns = document.querySelectorAll('.thumbnail-btn');

    thumbnailBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const src = btn.dataset.src;
        if (mainImage && src) {
          mainImage.src = src;
        }
        thumbnailBtns.forEach(b => b.classList.remove('border-midnight'));
        btn.classList.add('border-midnight');
      });
    });

    const nav = document.getElementById('ahd-global-nav');
    if (nav) {
      nav.classList.add('nav-dark');
      nav.classList.remove('nav-light');
      nav.style.setProperty('--nav-bg', 'rgba(1, 1, 4, 0.65)');
      nav.style.setProperty('--nav-border', 'rgba(255, 255, 255, 0.15)');
      nav.style.setProperty('--nav-foreground', 'rgba(255, 255, 255, 0.92)');
      nav.style.setProperty('--nav-hover', '#ffffff');
    }

    // Gestion de la quantité
    const qtyInput = document.getElementById('qty-input');
    const qtyMinus = document.getElementById('qty-minus');
    const qtyPlus = document.getElementById('qty-plus');
    const addToCartBtn = document.querySelector('.snipcart-add-item');
    const cartNotification = document.getElementById('cart-notification');

    const getQuantity = () => {
      const value = parseInt(qtyInput?.value || 1, 10);
      return isNaN(value) || value < 1 ? 1 : value;
    };

    const setQuantity = (qty) => {
      const validQty = Math.max(1, Math.floor(qty));
      if (qtyInput) {
        qtyInput.value = validQty;
      }
      if (addToCartBtn) {
        addToCartBtn.dataset.itemQuantity = validQty;
      }
    };

    const updateQuantity = () => {
      setQuantity(getQuantity());
    };

    // Afficher une notification quand le produit est ajouté au panier
    const showCartNotification = () => {
      if (cartNotification) {
        const qty = getQuantity();
        const notificationDetails = document.getElementById('notification-details');
        
        // Obtenir le nombre total d'articles dans le panier
        let totalItems = 0;
        if (window.Snipcart && window.Snipcart.store) {
          try {
            const cart = window.Snipcart.store.getState().cart.items;
            totalItems = cart.reduce((total, item) => total + (item.quantity || 1), 0);
          } catch (error) {
            console.error('Error getting cart items:', error);
          }
        }
        
        if (notificationDetails) {
          const pluralArticle = qty > 1 ? 'articles' : 'article';
          const pluralTotal = totalItems > 1 ? 'articles' : 'article';
          notificationDetails.textContent = `${qty} ${pluralArticle} ajouté(s) • Total: ${totalItems} ${pluralTotal}`;
        }
        
        cartNotification.classList.remove('opacity-0');
        setTimeout(() => {
          cartNotification.classList.add('opacity-0');
        }, 3500);
      }
      // Mettre à jour le badge du panier
      updateCartBadge();
    };

    // Mettre à jour le badge du panier
    const updateCartBadge = () => {
      if (window.Snipcart && window.Snipcart.store) {
        const cart = window.Snipcart.store.getState().cart.items;
        const badge = document.getElementById('cart-badge');
        if (badge) {
          badge.textContent = cart.length;
          badge.style.display = cart.length > 0 ? 'flex' : 'none';
        }
      }
    };

    // Ajouter un listener sur le clic du bouton Snippcart
    addToCartBtn?.addEventListener('click', () => {
      setTimeout(showCartNotification, 500);
    });

    // Écouter les changements du panier Snippcart
    if (window.Snipcart) {
      window.Snipcart.events.on('item.added', showCartNotification);
      window.Snipcart.events.on('item.removed', updateCartBadge);
      updateCartBadge();
    }

    qtyMinus?.addEventListener('click', (e) => {
      e.preventDefault();
      const currentQty = getQuantity();
      if (currentQty > 1) {
        setQuantity(currentQty - 1);
      }
    });

    qtyPlus?.addEventListener('click', (e) => {
      e.preventDefault();
      const currentQty = getQuantity();
      setQuantity(currentQty + 1);
    });

    qtyInput?.addEventListener('input', () => {
      const currentQty = getQuantity();
      qtyInput.value = currentQty;
      updateQuantity();
    });

    qtyInput?.addEventListener('blur', updateQuantity);
    
    // Initialisation
    updateQuantity();

    // Mise à jour des champs personnalisés Snipcart (couleur et taille)
    const initVariantUpdaters = () => {
      const snipcartButton = document.getElementById('snipcart-button');
      if (!snipcartButton) {
        console.log('Snipcart button not found');
        return;
      }

      // Chercher le select de taille (éviter les autres selects)
      const mainSection = document.querySelector('main');
      if (mainSection) {
        const sizeSelect = mainSection.querySelector('select');
        if (sizeSelect) {
          sizeSelect.addEventListener('change', () => {
            const selectedSize = sizeSelect.value;
            if (selectedSize && selectedSize !== 'Sélectionner') {
              snipcartButton.setAttribute('data-item-custom2-value', selectedSize);
            }
          });
        }
      }

      // Chercher les boutons de couleur
      const colorButtons = document.querySelectorAll('button[style*="background-color"]');
      if (colorButtons.length > 0) {
        colorButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            const colorName = btn.getAttribute('title');
            if (colorName) {
              snipcartButton.setAttribute('data-item-custom1-value', colorName);
            }
          });
        });
      }
    };

    // Attendre que le DOM soit prêt
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initVariantUpdaters);
    } else {
      initVariantUpdaters();
    }
  </script>
</Layout>
