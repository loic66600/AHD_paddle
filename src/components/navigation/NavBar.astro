---
import { withBase } from '../../utils/url';

const homeLink = withBase('/');
const logoSrc = withBase('/images/logo_blanc.png');
const categories = [
	{ href: withBase('/windsurf'), label: 'Windsurf' },
	{ href: withBase('/wingfoil'), label: 'Wingfoil' },
	{ href: withBase('/accessoires'), label: 'Accessoires' }
];

const accountPage = withBase('/compte');

const menuItems = [
	{ href: withBase('/#univers'), label: '> Univers AHD', children: categories },
	{ href: withBase('/#gamme'), label: 'Collection' },
	{ href: withBase('/#histoire'), label: 'Histoire' },
	{ href: withBase('/#decouvrir'), label: 'D√©couvrir' }
];
---

<div class="relative">
	<input id="ahd-drawer-toggle" type="checkbox" class="peer sr-only" />
	<input id="ahd-account-toggle" type="checkbox" class="peer/account sr-only" />

	<!-- Navigation principale avec menu fixe -->
	<header
		id="ahd-global-nav"
		class="nav-dark fixed inset-x-0 top-0 z-40 grid grid-cols-[auto_1fr_auto] items-center gap-4 px-6 py-5 md:px-12"
	>
		<label
			id="ahd-menu-button"
			for="ahd-drawer-toggle"
			class="nav-trigger text-sm uppercase tracking-[0.35em] focus:outline-none cursor-pointer"
			aria-controls="ahd-drawer"
			aria-expanded="false"
		>
			Menu
		</label>
		<a href={homeLink} class="nav-brand flex flex-col items-center gap-3 justify-self-center focus:outline-none">
			<img id="ahd-nav-logo" src={logoSrc} alt="AHD" class="nav-logo h-9 w-auto" loading="lazy" />
			<p class="nav-tagline text-xs uppercase tracking-[0.5em]">AHD Paddle Division</p>
		</a>
		<div class="flex items-center justify-self-end gap-4">
			<label
				id="ahd-account-button"
				for="ahd-account-toggle"
				class="group flex h-10 w-10 items-center justify-center rounded-full border border-white/30 text-white/80 transition hover:border-white/60 hover:text-white focus:outline-none cursor-pointer"
				aria-label="Compte utilisateur"
				aria-controls="ahd-account-panel"
				aria-expanded="false"
				role="button"
			>
				<svg viewBox="0 0 24 24" aria-hidden="true" class="h-5 w-5">
					<path
						fill="currentColor"
						d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z"
					/>
				</svg>
			</label>
			<a
				href={withBase('/panier')}
				class="group flex h-10 w-10 items-center justify-center rounded-full border border-white/30 text-white/80 transition hover:border-white/60 hover:text-white focus:outline-none"
				aria-label="Panier"
			>
				<svg viewBox="0 0 24 24" aria-hidden="true" class="h-5 w-5">
					<path
						fill="currentColor"
						d="M7 6V5a5 5 0 0 1 10 0v1h3v14H4V6h3Zm2 0h6V5a3 3 0 0 0-6 0v1Z"
					/>
				</svg>
			</a>
		</div>
	</header>

	<!-- Panneau compte glissant depuis la droite -->
	<aside
		id="ahd-account-panel"
		class="fixed inset-y-0 right-0 z-50 w-[min(90vw,420px)] translate-x-full bg-white text-midnight shadow-[0_24px_60px_rgba(15,23,42,0.25)] transition-transform duration-500 will-change-transform peer-checked/account:translate-x-0"
		aria-labelledby="ahd-account-title"
	>
		<div class="flex items-center justify-between border-b border-midnight/10 px-6 py-5">
			<div class="flex items-center gap-3">
				<span class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-midnight/20">
					<svg viewBox="0 0 24 24" aria-hidden="true" class="h-5 w-5 text-midnight/80">
						<path
							fill="currentColor"
							d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z"
						/>
					</svg>
				</span>
				<h2 id="ahd-account-title" class="text-base font-semibold">Mon compte</h2>
			</div>
			<button
				type="button"
				data-account-close
				class="inline-flex items-center gap-2 rounded-full border border-midnight/15 px-3 py-2 text-xs font-semibold uppercase tracking-[0.25em] text-midnight/70 transition hover:border-midnight/30 hover:text-midnight"
			>
				<span>fermer</span>
				<span aria-hidden="true" class="text-base leading-none">√ó</span>
			</button>
		</div>
		<div class="px-6 py-6 space-y-8">
			<div class="space-y-4 text-center">
				<p class="text-sm font-semibold tracking-[0.3em] text-midnight/80" data-account-title>CONNEXION</p>
			</div>
			<form class="space-y-4" data-account-login>
				<div class="space-y-2">
					<label for="account-email" class="text-xs font-semibold text-midnight/70">E-Mail*</label>
					<input
						id="account-email"
						type="email"
						placeholder="E-Mail*"
						required
						class="w-full rounded-full border border-midnight/20 bg-slate-50 px-4 py-3 text-sm text-midnight placeholder:text-midnight/40 focus:border-midnight focus:outline-none"
					/>
				</div>
				<div class="space-y-2">
					<label for="account-password" class="text-xs font-semibold text-midnight/70">Mot de passe</label>
					<input
						id="account-password"
						type="password"
						placeholder="Mot de passe"
						required
						class="w-full rounded-full border border-midnight/20 bg-slate-50 px-4 py-3 text-sm text-midnight placeholder:text-midnight/40 focus:border-midnight focus:outline-none"
					/>
				</div>
				<a href={withBase('/')} class="text-xs font-semibold text-midnight underline underline-offset-2">Mot de passe oubli√© ?</a>
				<button type="submit" class="mt-4 w-full rounded-full bg-midnight px-5 py-3 text-xs font-semibold uppercase tracking-[0.35em] text-white">
					Connexion
				</button>
			</form>

			<form class="space-y-4 hidden" data-account-signup-form>
				<div class="space-y-2">
					<label for="signup-firstname" class="text-xs font-semibold text-midnight/70">Pr√©nom</label>
					<input
						id="signup-firstname"
						type="text"
						placeholder="Votre pr√©nom"
						required
						class="w-full rounded-full border border-midnight/20 bg-slate-50 px-4 py-3 text-sm text-midnight placeholder:text-midnight/40 focus:border-midnight focus:outline-none"
					/>
				</div>
				<div class="space-y-2">
					<label for="signup-lastname" class="text-xs font-semibold text-midnight/70">Nom</label>
					<input
						id="signup-lastname"
						type="text"
						placeholder="Votre nom"
						required
						class="w-full rounded-full border border-midnight/20 bg-slate-50 px-4 py-3 text-sm text-midnight placeholder:text-midnight/40 focus:border-midnight focus:outline-none"
					/>
				</div>
				<div class="space-y-2">
					<label for="signup-email" class="text-xs font-semibold text-midnight/70">E-Mail*</label>
					<input
						id="signup-email"
						type="email"
						placeholder="E-Mail*"
						required
						class="w-full rounded-full border border-midnight/20 bg-slate-50 px-4 py-3 text-sm text-midnight placeholder:text-midnight/40 focus:border-midnight focus:outline-none"
					/>
				</div>
				<div class="space-y-2">
					<label for="signup-password" class="text-xs font-semibold text-midnight/70">Mot de passe</label>
					<input
						id="signup-password"
						type="password"
						placeholder="Mot de passe"
						required
						class="w-full rounded-full border border-midnight/20 bg-slate-50 px-4 py-3 text-sm text-midnight placeholder:text-midnight/40 focus:border-midnight focus:outline-none"
					/>
				</div>
				<button type="submit" class="mt-4 w-full rounded-full bg-midnight px-5 py-3 text-xs font-semibold uppercase tracking-[0.35em] text-white">
					Cr√©er mon compte
				</button>
			</form>

			<div class="pt-2 space-y-3 text-center" data-account-cta>
				<p class="text-xs font-semibold uppercase tracking-[0.3em] text-midnight/70">N‚Äô√äTES-VOUS PAS ENCORE INSCRIT ?</p>
				<p class="text-sm text-midnight/70">
					Inscris-toi maintenant pour suivre tes commandes et pour avoir un acc√®s gratuit au contenu premium exclusif de AHD
				</p>
				<button
					type="button"
					data-account-signup
					class="w-full rounded-full bg-midnight px-5 py-3 text-xs font-semibold uppercase tracking-[0.35em] text-white"
				>
					Inscris-toi
				</button>
			</div>
		</div>
	</aside>

	<!-- Pop-up inscription centr√©e -->
	<div
		id="ahd-signup-modal"
		class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/50 px-4"
		role="dialog"
		aria-modal="true"
		aria-labelledby="ahd-signup-title"
	>
		<div class="relative w-full max-w-md rounded-3xl bg-white p-6 text-midnight shadow-[0_24px_60px_rgba(15,23,42,0.25)]">
			<button
				type="button"
				data-signup-close
				class="absolute right-4 top-4 inline-flex h-9 w-9 items-center justify-center rounded-full border border-midnight/15 text-midnight/70 transition hover:border-midnight/30 hover:text-midnight"
				aria-label="Fermer"
			>
				<span aria-hidden="true" class="text-lg leading-none">√ó</span>
			</button>
			<div class="space-y-4 text-center">
				<p id="ahd-signup-title" class="text-sm font-semibold tracking-[0.3em] text-midnight/80">INSCRIPTION</p>
				<p class="text-sm text-midnight/60">Cr√©e ton compte AHD en quelques secondes.</p>
			</div>
			<form class="mt-6 space-y-4" data-signup-modal-form>
				<div class="space-y-2">
					<label for="signup-modal-firstname" class="text-xs font-semibold text-midnight/70">Pr√©nom</label>
					<input
						id="signup-modal-firstname"
						type="text"
						placeholder="Votre pr√©nom"
						required
						class="w-full rounded-full border border-midnight/20 bg-slate-50 px-4 py-3 text-sm text-midnight placeholder:text-midnight/40 focus:border-midnight focus:outline-none"
					/>
				</div>
				<div class="space-y-2">
					<label for="signup-modal-lastname" class="text-xs font-semibold text-midnight/70">Nom</label>
					<input
						id="signup-modal-lastname"
						type="text"
						placeholder="Votre nom"
						required
						class="w-full rounded-full border border-midnight/20 bg-slate-50 px-4 py-3 text-sm text-midnight placeholder:text-midnight/40 focus:border-midnight focus:outline-none"
					/>
				</div>
				<div class="space-y-2">
					<label for="signup-modal-email" class="text-xs font-semibold text-midnight/70">E-Mail*</label>
					<input
						id="signup-modal-email"
						type="email"
						placeholder="E-Mail*"
						required
						class="w-full rounded-full border border-midnight/20 bg-slate-50 px-4 py-3 text-sm text-midnight placeholder:text-midnight/40 focus:border-midnight focus:outline-none"
					/>
				</div>
				<div class="space-y-2">
					<label for="signup-modal-password" class="text-xs font-semibold text-midnight/70">Mot de passe</label>
					<input
						id="signup-modal-password"
						type="password"
						placeholder="Mot de passe"
						required
						class="w-full rounded-full border border-midnight/20 bg-slate-50 px-4 py-3 text-sm text-midnight placeholder:text-midnight/40 focus:border-midnight focus:outline-none"
					/>
				</div>
				<button type="submit" class="mt-2 w-full rounded-full bg-midnight px-5 py-3 text-xs font-semibold uppercase tracking-[0.35em] text-white">
					S‚Äôenregistrer
				</button>
			</form>
		</div>
	</div>

	<div
		id="ahd-drawer"
		class="fixed inset-y-0 left-0 z-50 w-72 max-w-xs -translate-x-full transform bg-midnight/95 px-8 py-12 transition-all duration-500 will-change-transform overflow-visible peer-checked:translate-x-0 lg:w-[24rem] lg:max-w-none lg:px-10"
	>
		<div class="flex h-full flex-col">
			<nav class="relative flex flex-col gap-8 text-sm uppercase tracking-[0.35em] text-foam/80 lg:gap-10 lg:w-[18rem] lg:h-full">
				{menuItems.map((item) => (
					<div class="flex flex-col gap-3 group/menu relative lg:static" role="group">
						<a href={item.href} class="flex items-center justify-between gap-4">
							<span>{item.label}</span>
							{item.children && <span aria-hidden="true" class="text-base text-foam/40 transition-transform duration-200 group-hover/menu:translate-x-1">&rarr;</span>}
						</a>
						{item.children && (
							<div class="submenu-panel flex flex-col gap-3 pl-5 text-sm uppercase tracking-[0.35em] text-foam/80 lg:absolute lg:-top-12 lg:-bottom-12 lg:left-[18rem] lg:w-[18rem] lg:bg-midnight/95 lg:px-10 lg:py-12 lg:text-left lg:opacity-0 lg:pointer-events-none lg:transition lg:duration-200 lg:border-l lg:border-white/10 lg:group-hover/menu:opacity-100 lg:group-hover/menu:pointer-events-auto lg:group-hover/menu:translate-x-0 lg:group-focus-within/menu:opacity-100 lg:group-focus-within/menu:pointer-events-auto lg:group-focus-within/menu:translate-x-0">
								{item.children.map((child) => (
									<a href={child.href} class="flex items-center justify-between gap-3 text-foam/80 hover:text-gold">
										<span>{child.label}</span>
										<span aria-hidden="true" class="text-base font-normal text-foam/50">&rarr;</span>
									</a>
								))}
							</div>
						)}
					</div>
				))}
			</nav>
			<a
				href={accountPage}
				class="mt-auto inline-flex items-center justify-between gap-4 text-sm uppercase tracking-[0.35em] text-foam/80 hover:text-gold"
			>
				<span>Mon compte</span>
				<span aria-hidden="true" class="text-base text-foam/40">&rarr;</span>
			</a>
		</div>
	</div>

	<label
		for="ahd-drawer-toggle"
		id="ahd-drawer-overlay"
		class="fixed inset-0 z-40 bg-black/50 opacity-0 pointer-events-none transition-opacity duration-300 peer-checked:opacity-100 peer-checked:pointer-events-auto"
		aria-hidden="true"
	></label>

	<label
		for="ahd-account-toggle"
		class="fixed inset-0 z-40 bg-black/40 opacity-0 pointer-events-none transition-opacity duration-300 peer-checked/account:opacity-100 peer-checked/account:pointer-events-auto"
		aria-hidden="true"
	></label>

	<script type="module" is:inline define:vars={{accountPage}}>
		const drawerToggle = document.getElementById('ahd-drawer-toggle');
		const drawer = document.getElementById('ahd-drawer');
		const menuButton = document.getElementById('ahd-menu-button');
		const accountToggle = document.getElementById('ahd-account-toggle');
		const accountButton = document.getElementById('ahd-account-button');
		const accountCloseButton = document.querySelector('[data-account-close]');
		const accountSignupButton = document.querySelector('[data-account-signup]');
		const signupModal = document.getElementById('ahd-signup-modal');
		const signupModalForm = document.querySelector('[data-signup-modal-form]');
		const signupModalClose = document.querySelector('[data-signup-close]');
		const accountPanel = document.getElementById('ahd-account-panel');
		const docEl = document.documentElement;
		const accountPageUrl = accountPage;
		const accountStorageKey = 'ahd-account-active';
		
		const getStorage = () => {
			try {
				return window.localStorage;
			} catch (error) {
				return null;
			}
		};

		// G√©rer l'expansion du drawer au survol du sous-menu
		const menuGroups = document.querySelectorAll('[role="group"]');
		
		menuGroups.forEach((group) => {
			const hasSubmenu = Boolean(group.querySelector('.submenu-panel'));
			if (!hasSubmenu) return;
			group.addEventListener('mouseenter', () => {
				if (drawer && drawerToggle?.checked) {
					drawer.classList.add('submenu-active');
				}
			});
			group.addEventListener('mouseleave', () => {
				if (drawer) {
					drawer.classList.remove('submenu-active');
				}
			});
		});

		if (drawerToggle && menuButton) {
			menuButton.setAttribute('aria-expanded', String(drawerToggle.checked));
			drawerToggle.addEventListener('change', () => {
				menuButton.setAttribute('aria-expanded', String(drawerToggle.checked));
			});
		}

		if (accountToggle && accountButton && accountPanel) {
			accountButton.setAttribute('aria-expanded', String(accountToggle.checked));
			const syncAccountState = () => {
				accountButton.setAttribute('aria-expanded', String(accountToggle.checked));
				docEl.classList.toggle('account-open', accountToggle.checked);
				accountPanel.classList.toggle('is-open', accountToggle.checked);
			};
			accountToggle.addEventListener('change', syncAccountState);
			accountButton.addEventListener('click', (event) => {
				const storage = getStorage();
				const hasAccount = storage?.getItem(accountStorageKey) === 'true';
				if (hasAccount) {
					event.preventDefault();
					accountToggle.checked = false;
					syncAccountState();
					window.location.href = accountPageUrl;
					return;
				}
				setTimeout(syncAccountState, 0);
			});
			syncAccountState();
		}

		// Gestion des clics sur les liens du drawer
		const closeMenu = () => {
			console.log('üî¥ Closing menu...');
			if (drawerToggle) {
				drawerToggle.checked = false;
				console.log('‚úÖ Drawer toggle unchecked');
			}
			if (menuButton) {
				menuButton.setAttribute('aria-expanded', 'false');
			}
			if (drawer) {
				drawer.classList.remove('submenu-active');
			}
		};

		// Observer pour les changements dans le drawer (sous-menu)
		if (drawer) {
			const setupLinkHandlers = () => {
				const allLinks = drawer.querySelectorAll('a');
				console.log('üîó Setting up handlers for', allLinks.length, 'links');
				
				allLinks.forEach((link, index) => {
					const href = link.getAttribute('href');
					console.log(`üìé Link ${index}: ${href} - ${link.textContent.trim()}`);
					
					// Supprimer l'ancien handler pour √©viter les doublons
					link.removeEventListener('click', link._clickHandler);
					
					// Cr√©er le nouveau handler
					const clickHandler = (e) => {
						console.log('üñ±Ô∏è Clicked on link:', href, 'Current page:', window.location.pathname);
						
						// Pour les liens d'ancrage locaux
						if (href && href.startsWith('#')) {
							e.preventDefault();
							console.log('üéØ Anchor link detected, closing menu...');
							closeMenu();
							
							setTimeout(() => {
								const targetId = href.substring(1);
								const targetEl = document.getElementById(targetId);
								console.log('üìç Looking for element:', targetId, 'Found:', !!targetEl);
								if (targetEl) {
									targetEl.scrollIntoView({ behavior: 'smooth' });
									console.log('üìú Scrolled to element');
								}
							}, 250);
						} else if (href && href.includes('#')) {
							// Pour les liens avec ancrage vers d'autres pages (comme /#gamme)
							console.log('üîó Cross-page anchor link detected');
							closeMenu();
						} else {
							// Pour tous les autres liens
							console.log('üîó Regular link, closing menu');
							closeMenu();
						}
					};
					
					// Sauvegarder la r√©f√©rence du handler
					link._clickHandler = clickHandler;
					link.addEventListener('click', clickHandler);
				});
			};

			// Setup initial
			console.log('üöÄ Initial setup of link handlers');
			setupLinkHandlers();

			// Observer pour les changements DOM (sous-menu qui appara√Æt/dispara√Æt)
			const observer = new MutationObserver((mutations) => {
				let hasChanges = false;
				mutations.forEach(mutation => {
					if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
						hasChanges = true;
					}
				});
				if (hasChanges) {
					console.log('üîÑ DOM changed, re-setting up handlers...');
					setTimeout(setupLinkHandlers, 50);
				}
			});
			
			observer.observe(drawer, { 
				childList: true, 
				subtree: true,
				attributes: true,
				attributeFilter: ['class']
			});
		}

		// Fermer le menu en cliquant sur l'overlay
		const overlay = document.getElementById('ahd-drawer-overlay');
		if (overlay) {
			overlay.addEventListener('click', (e) => {
				e.preventDefault();
				console.log('üñ±Ô∏è Clicked on overlay, closing menu');
				closeMenu();
			});
		}

		if (accountToggle && accountPanel) {
			const closeAccount = () => {
				accountToggle.checked = false;
				if (accountButton) {
					accountButton.setAttribute('aria-expanded', 'false');
				}
				docEl.classList.remove('account-open');
				accountPanel.classList.remove('is-open');
			};

			accountCloseButton?.addEventListener('click', closeAccount);
			
			// Direct signup button handler
			if (accountSignupButton) {
				accountSignupButton.addEventListener('click', () => {
					closeAccount();
					setTimeout(() => {
						signupModal.classList.remove('hidden');
						signupModal.classList.add('flex');
					}, 50);
				});
			}
			
			signupModalClose?.addEventListener('click', () => {
				signupModal?.classList.add('hidden');
				signupModal?.classList.remove('flex');
			});
			signupModal?.addEventListener('click', (event) => {
				if (event.target === signupModal) {
					signupModal.classList.add('hidden');
					signupModal.classList.remove('flex');
				}
			});
			signupModalForm?.addEventListener('submit', (event) => {
				event.preventDefault();
				const storage = getStorage();
				storage?.setItem(accountStorageKey, 'true');
				signupModal?.classList.add('hidden');
				signupModal?.classList.remove('flex');
				window.location.href = accountPageUrl;
			});

			window.addEventListener('keydown', (event) => {
				if (event.key === 'Escape' && accountToggle.checked) {
					closeAccount();
				}
			});

			window.addEventListener(
				'click',
				(event) => {
					if (accountToggle.checked && accountPanel && !accountPanel.contains(event.target) && !accountButton?.contains(event.target)) {
						closeAccount();
					}
				},
				true
			);
		}
	</script>
</div>
